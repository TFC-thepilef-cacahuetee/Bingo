<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Sala de Bingo ğŸ‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div class="sala-container">
        <h1>ğŸ² Sala de Bingo: <span id="codigoSala">{{ codigo_sala }}</span></h1>
        <h2>Jugadores en la sala:</h2>
        <div id="jugadores" class="jugadores-lista"></div>

        <button id="btnListo">Estoy Listo âœ…</button>
        <button id="salirSalaBtn">Salir de la Sala âŒ</button>

        <div id="ganadorAnuncio" class="ganador-anuncio" style="display: none;"></div>

        <div id="botonesAccion" class="botones-accion" style="display: none;">
            <button id="btnBingoLinea">Cantar LÃ­nea</button>
            <button id="btnVerificarBingo" disabled>Cantar Bingo</button>
        </div>

        <div id="mensajeValidacion" class="mensaje-validacion"></div>

        <div id="contenedor-numeros" class="numeros-container" style="display: none;">
            <div class="numeros-titulo">NÃºmeros salidos:</div>
            <div id="lista-numeros" class="numeros-lista"></div>
        </div>
    </div>

    <div id="contenedor-cartones" class="bingo-container"></div>

    <script>
        const socket = io();
        const codigoSala = "{{ codigo_sala }}";
        const username = "{{ username }}";

        // Variables globales
        let numerosSalidos = [];
        let modoLinea = true; // Comienza en modo lÃ­nea
        let lineaCantada = false; // Para evitar mÃºltiples cantos de lÃ­nea
        const botonesAccion = document.getElementById('botonesAccion');
        const mensajeValidacion = document.getElementById('mensajeValidacion');

        socket.emit('unirse_sala', { codigo_sala: codigoSala, username: username });

        const btnListo = document.getElementById('btnListo');
        const jugadoresDiv = document.getElementById('jugadores');

        btnListo.addEventListener('click', () => {
            socket.emit('jugador_listo', { codigo_sala: codigoSala, username: username });
            btnListo.disabled = true;
        });

        socket.on('actualizar_jugadores_listos', data => {
            jugadoresDiv.innerHTML = '';
            data.jugadores.forEach(jugador => {
                const div = document.createElement('div');
                div.className = 'jugador';
                let estado = data.listos[jugador] ? 'âœ… Listo' : 'âŒ No listo';
                div.textContent = `${jugador} - ${estado}`;
                jugadoresDiv.appendChild(div);
            });
        });

        function marcarNumero(celda, numero) {
            const marcado = !celda.classList.contains('marked');
            celda.classList.toggle('marked');

            if (marcado) {
                celda.classList.remove('marked-otro');
            }

            socket.emit('numero_marcado', {
                numero: numero,
                marcado: celda.classList.contains('marked'),
                codigo_sala: codigoSala,
                username: username
            });

            actualizarEstadoBotones();
        }




        function verificarNumerosMarcados(carton) {
            const celdasMarcadas = carton.querySelectorAll('.bingo-cell.marked:not(.free)');
            const numerosMarcados = Array.from(celdasMarcadas).map(celda => parseInt(celda.textContent));

            const todosSalidos = numerosMarcados.every(numero => numerosSalidos.includes(numero));

            return {
                todosSalidos,
                numerosMarcados
            };
        }

        function verificarLineasCompletas(carton) {
            const filas = carton.querySelectorAll('.bingo-row');
            let lineasCompletas = 0;

            // Verificar solo filas horizontales (no columnas ni diagonales)
            filas.forEach(fila => {
                const celdas = fila.querySelectorAll('.bingo-cell:not(.free)');
                const todasMarcadas = Array.from(celdas).every(c => c.classList.contains('marked'));
                if (todasMarcadas) {
                    lineasCompletas++;
                    resaltarLinea(celdas);
                }
            });

            return lineasCompletas;
        }

        function resaltarLinea(celdas) {
            celdas.forEach(celda => {
                if (celda) celda.classList.add('linea-completa');
            });
        }

        function verificarBingoCompleto(carton) {
            const todasCeldas = carton.querySelectorAll('.bingo-cell:not(.free)');
            return Array.from(todasCeldas).every(c => c.classList.contains('marked'));
        }

        function mostrarMensaje(tipo, mensaje) {
            mensajeValidacion.textContent = mensaje;
            mensajeValidacion.className = 'mensaje-validacion';

            if (tipo === 'exito') {
                mensajeValidacion.classList.add('mensaje-exito');
            } else {
                mensajeValidacion.classList.add('mensaje-error');
            }

            setTimeout(() => {
                mensajeValidacion.textContent = '';
                mensajeValidacion.className = 'mensaje-validacion';
            }, 5000);
        }

        function actualizarEstadoBotones() {
            const carton = document.querySelector('.bingo-card-wrapper[data-jugador="' + username + '"] .bingo-card');
            if (!carton) return;

            const totalCeldas = carton.querySelectorAll('.bingo-cell:not(.free)').length;
            const marcados = carton.querySelectorAll('.bingo-cell.marked:not(.free)').length;


            const btnVerificarBingo = document.getElementById('btnVerificarBingo');
            const btnBingoLinea = document.getElementById('btnBingoLinea');
            
            if (btnVerificarBingo) {
                btnVerificarBingo.disabled = marcados !== totalCeldas;
            }

            if (btnBingoLinea && !lineaCantada) {
                btnBingoLinea.disabled = marcados === 0;;
            }
        }

        btnBingoLinea.addEventListener('click', () => {
            const carton = document.querySelector('.bingo-card-wrapper[data-jugador="' + username + '"] .bingo-card');
            const { todosSalidos, numerosMarcados } = verificarNumerosMarcados(carton);

            if (!todosSalidos) {
                mostrarMensaje('error', 'âš ï¸ No puedes cantar. Hay nÃºmeros marcados que no han salido.');

                socket.emit('intento_invalido', {
                    codigo_sala: codigoSala,
                    username: username,
                    tipo: 'linea',
                    valido: false,
                    motivo: 'NÃºmeros no salidos: ' + numerosMarcados.filter(n => !numerosSalidos.includes(n)).join(', ')
            });
            return;
        }

        const lineasCompletas = verificarLineasCompletas(carton);

        if (lineasCompletas > 0) {
            mostrarMensaje('exito', 'Â¡LÃNEA VÃLIDA! ğŸ‰');
            socket.emit('bingo_completado', {
                codigo_sala: codigoSala,
                username: username,
                tipo: 'linea',
                cantidad: lineasCompletas,
                valido: true
            });

            btnBingoLinea.disabled = true;
            btnVerificarBingo.disabled = false; // Activamos botÃ³n de BINGO
        } else {
            mostrarMensaje('error', 'âš ï¸ No tienes ninguna lÃ­nea horizontal completa.');
            socket.emit('intento_invalido', {
                codigo_sala: codigoSala,
                username: username,
                tipo: 'linea',
                valido: false,
                motivo: 'No hay lÃ­nea horizontal completa'
            });
        }
    });


        // Nuevos listeners para manejar los eventos de cambi
        socket.on('cambio_a_bingo', () => {
            modoLinea = false;
            lineaCantada = true;
            btnBingoLinea.textContent = 'Cantar Bingo';
            btnBingoLinea.style.backgroundColor = '#4CAF50';
            mostrarMensaje('info', 'Â¡Alguien ha cantado lÃ­nea! Ahora solo se puede cantar BINGO.');
        });

        document.getElementById('salirSalaBtn').addEventListener('click', function () {
            socket.emit('salir_sala', { codigo_sala: codigoSala, username: username });
            setTimeout(function () {
                window.location.href = "/dashboard";
            }, 300);
        });

        socket.on('partida_iniciada', (data) => {
            alert('ğŸš€ Â¡La partida ha comenzado!');

            document.getElementById('contenedor-numeros').style.display = 'block';
            
            botonesAccion.style.display = 'block';
            numerosSalidos = [];

            // Resetear a modo lÃ­nea al comenzar nueva partida
            modoLinea = true;
            btnBingoLinea.textContent = 'Cantar LÃ­nea';
            btnBingoLinea.style.backgroundColor = '#FFA500';

            const contenedor = document.getElementById('contenedor-cartones');
            contenedor.innerHTML = '';

            Object.keys(data.cartones).forEach(nombreJugador => {
                const carton = data.cartones[nombreJugador];
                const wrapper = document.createElement('div');
                wrapper.className = 'bingo-card-wrapper';
                wrapper.dataset.jugador = nombreJugador.trim().toLowerCase();

                const title = document.createElement('div');
                title.className = 'card-title';
                title.textContent = nombreJugador.trim().toLowerCase() === username.trim().toLowerCase()
                    ? 'Tu cartÃ³n'
                    : `CartÃ³n de ${nombreJugador}`;                
                wrapper.appendChild(title);

                const cardDiv = document.createElement('div');
                cardDiv.className = 'bingo-card';

                const header = document.createElement('div');
                header.className = 'bingo-header';
                ['B', 'I', 'N', 'G', 'O'].forEach(letra => {
                    const letraDiv = document.createElement('div');
                    letraDiv.textContent = letra;
                    header.appendChild(letraDiv);
                });
                cardDiv.appendChild(header);

                carton.forEach(fila => {
                    const filaDiv = document.createElement('div');
                    filaDiv.className = 'bingo-row';

                    fila.forEach((celda, index) => {
                        const celdaDiv = document.createElement('div');
                        celdaDiv.className = 'bingo-cell';

                        if (celda === "") {
                            celdaDiv.classList.add('free');
                            celdaDiv.textContent = "";
                        } else {
                            celdaDiv.textContent = celda;
                            if (nombreJugador.trim().toLocaleLowerCase() === username.trim().toLocaleLowerCase()) {
                                celdaDiv.onclick = function () {
                                    marcarNumero(this, celda);
                                };
                            } else {
                                celdaDiv.style.cursor = 'default';
                            }
                        }

                        filaDiv.appendChild(celdaDiv);
                    });

                    cardDiv.appendChild(filaDiv);
                });

                wrapper.appendChild(cardDiv);
                contenedor.appendChild(wrapper);
            });

            btnListo.disabled = true;
            actualizarEstadoBotones();
        });

        socket.on('numero_nuevo', data => {
            const listaNumeros = document.getElementById('lista-numeros');
            const numeroDiv = document.createElement('div');
            numeroDiv.className = 'numero-bola';
            numeroDiv.textContent = data.numero;
            listaNumeros.appendChild(numeroDiv);

            numerosSalidos.push(data.numero);
        });

        socket.on('numero_marcado', data => {
            const { numero, username: jugadorQueMarco, marcado } = data;

            // Localiza el cartÃ³n del jugador que marcÃ³ el nÃºmero
            const cartonDelJugador = document.querySelector(`.bingo-card-wrapper[data-jugador="${jugadorQueMarco}"] .bingo-card`);
            if (!cartonDelJugador) return;

            cartonDelJugador.querySelectorAll('.bingo-cell').forEach(celda => {
                if (celda.textContent == numero) {
                    // Limpia clases anteriores
                    celda.classList.remove('marked', 'marked-otro');

                    if (marcado) {
                        if (jugadorQueMarco.trim().toLowerCase() === username.trim().toLowerCase()) {
                            celda.classList.add('marked'); // verde si soy yo
                        } else {
                            celda.classList.add('marked-otro'); // naranja si es otro
                        }
                    }
                }
            });
        });


        socket.on('fin_partida', () => {
            alert('ğŸ‰ Â¡Se han emitido todos los nÃºmeros! La partida ha terminado.');
            botonesAccion.style.display = 'none';
        });


        socket.on('bingo_completado', data => {
            const mensaje = data.tipo === 'linea'
                ? `ğŸ‰ Â¡${data.username} ha cantado LÃNEA! (${data.cantidad} lÃ­nea(s))`
                : `ğŸ† Â¡${data.username} ha cantado BINGO!`;

            mostrarMensaje('info', mensaje);

            if (data.tipo === 'linea' && !lineaCantada) {
                lineaCantada = true;

                // AquÃ­ es donde habilitamos el botÃ³n de bingo
                document.getElementById('btnVerificarBingo').disabled = false;
            }

            // Mostrar quiÃ©n ganÃ³ el bingo
            if (data.tipo === 'bingo') {
                document.getElementById('ganadorAnuncio').textContent = `ğŸ‰ Â¡${data.username} ha ganado el BINGO! ğŸ‰`;
                document.getElementById('ganadorAnuncio').style.display = 'block';

                // Desactivar botones para todos
                document.getElementById('btnBingoLinea').disabled = true;
                document.getElementById('btnVerificarBingo').disabled = true;
            }
        });


        socket.on('intento_invalido', data => {
            if (data.username !== username) {
                mostrarMensaje('error', `âŒ ${data.username} intentÃ³ cantar ${data.tipo.toUpperCase()} pero no era vÃ¡lido (${data.motivo})`);
            }
        });

        btnVerificarBingo.addEventListener('click', () => {
            const carton = document.querySelector('.bingo-card-wrapper[data-jugador="' + username + '"] .bingo-card');
            const { todosSalidos, numerosMarcados } = verificarNumerosMarcados(carton);

            if (todosSalidos && verificarBingoCompleto(carton)) {
                mostrarMensaje('exito', 'ğŸ‰ Â¡BINGO VÃLIDO! Â¡Eres el ganador!');

                // Mostrar anuncio de ganador
                document.getElementById('ganadorAnuncio').textContent = `ğŸ‰ Â¡${username} ha ganado el BINGO! ğŸ‰`;
                document.getElementById('ganadorAnuncio').style.display = 'block';

                // Emitir al servidor
                socket.emit('bingo_completado', {
                    codigo_sala: codigoSala,
                    username: username,
                    tipo: 'bingo',
                    valido: true
                });

                // Desactivar botones para evitar nuevos bingos
                btnVerificarBingo.disabled = true;
                btnBingoLinea.disabled = true;

            } else {
                const noSalidos = numerosMarcados.filter(n => !numerosSalidos.includes(n));
                mostrarMensaje('error', 'âŒ AÃºn hay nÃºmeros que no han salido ');
                socket.emit('intento_invalido', {
                    codigo_sala: codigoSala,
                    username: username,
                    tipo: 'bingo',
                    valido: false,
                    motivo: 'NÃºmeros no salidos '
                });
            }
        });

        socket.on('ganador_bingo', data => {
            const ganadorDiv = document.getElementById('ganadorAnuncio');
            ganadorDiv.textContent = `ğŸ‰ Â¡${data.username} ha ganado el BINGO! ğŸ‰`;
            ganadorDiv.style.display = 'block';

            // Desactivar los botones para todos
            btnBingoLinea.disabled = true;
            const btnVerificarBingo = document.getElementById('btnVerificarBingo');
            if (btnVerificarBingo) btnVerificarBingo.disabled = true;
        });




    </script>
</body>

</html>